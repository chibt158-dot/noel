<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Magic Christmas – Hand Move Show Photo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
body { margin:0; overflow:hidden; background:black; }
#startBtn {
    position:absolute; bottom:30px; left:50%;
    transform:translateX(-50%);
    padding:15px 40px;
    font-size:18px;
    border-radius:30px;
    border:2px solid gold;
    background:#b30000;
    color:white;
    cursor:pointer;
    z-index:10;
}
</style>
</head>

<body>

<button id="startBtn">START MAGIC</button>

<video class="input_video" style="display:none"></video>

<script>
/* =======================
   THREE.JS BASIC
======================= */
let scene, camera, renderer;
let photoMeshes = [];
let lastHandX = 0.5;
let movePower = 0;

init3D();

function init3D(){
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 60;

    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const loader = new THREE.TextureLoader();
    const imgs = [
        "image1.jpeg",
        "image2.jpeg",
        "image3.jpeg",
        "image4.jpeg",
        "image5.jpeg"
    ];

    imgs.forEach((src,i)=>{
        const mat = new THREE.MeshBasicMaterial({
            map: loader.load(src),
            transparent:true,
            opacity:0
        });
        const mesh = new THREE.Mesh(new THREE.PlaneGeometry(10,10), mat);
        mesh.position.x = (i-2)*12;
        scene.add(mesh);
        photoMeshes.push(mesh);
    });

    animate();
}

function animate(){
    requestAnimationFrame(animate);

    photoMeshes.forEach((m,i)=>{
        // hiện ảnh khi tay di chuyển
        m.material.opacity += (movePower - m.material.opacity) * 0.1;
        m.rotation.y += 0.005;
    });

    movePower *= 0.92; // giảm dần khi không di chuyển
    renderer.render(scene,camera);
}

/* =======================
   HAND TRACKING
======================= */
document.getElementById("startBtn").onclick = () => {
    document.getElementById("startBtn").style.display="none";
    startHand();
};

function startHand(){
    const video = document.querySelector(".input_video");

    const hands = new Hands({
        locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
    });

    hands.setOptions({
        maxNumHands:1,
        minDetectionConfidence:0.6,
        minTrackingConfidence:0.6
    });

    hands.onResults(res=>{
        if(res.multiHandLandmarks.length){
            const x = res.multiHandLandmarks[0][9].x;
            const dx = Math.abs(x - lastHandX);

            if(dx > 0.01){
                movePower = Math.min(1, movePower + dx * 5);
            }
            lastHandX = x;
        }
    });

    const cam = new Camera(video,{
        onFrame: async()=>{ await hands.send({image:video}); },
        width:640,
        height:480
    });
    cam.start();
}

/* =======================
   RESIZE
======================= */
window.addEventListener("resize",()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
